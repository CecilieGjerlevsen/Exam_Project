---
title: "Exploratory data analysis"
output: html_document
---

Loading the dataset:
```{r, echo=FALSE}
master_data <- read.csv("master_data.csv")
descriptions <- read.csv("columns_description.csv")
```

Loading packages:
```{r, echo=FALSE}
pacman::p_load(
  ggplot2,
  data.table,
  dplyr,
  cowplot,
  dplyr,
  rlang,
  forcats,
  tidyverse,
  psych)
```

Standardizing:
```{r}
master_data$AMT_INCOME_TOTAL <- (master_data$AMT_INCOME_TOTAL - mean(master_data$AMT_INCOME_TOTAL)) / sd(master_data$AMT_INCOME_TOTAL)
master_data$AMT_CREDIT <- (master_data$AMT_CREDIT - mean(master_data$AMT_CREDIT)) / sd(master_data$AMT_CREDIT)
master_data$AMT_ANNUITY <- (master_data$AMT_ANNUITY - mean(master_data$AMT_ANNUITY)) / sd(master_data$AMT_ANNUITY)
master_data$AMT_GOODS_PRICE <- (master_data$AMT_GOODS_PRICE - mean(master_data$AMT_GOODS_PRICE)) / sd(master_data$AMT_GOODS_PRICE)
```

Plot of target variable - Imbalance plot:
```{r}
master_data %>% 
    count(TARGET,  factor(TARGET)) %>% 
    mutate(pct = prop.table(n)) %>% 
    ggplot(aes(x = TARGET, y = pct, fill = factor(TARGET), label = scales::percent(pct))) + 
    geom_col(position = 'dodge') + 
    geom_text(position = position_dodge(width = .9), vjust = -0.5, size = 4) + 
    scale_y_continuous(labels=scales::percent) +
    scale_x_continuous(breaks=c(0,1)) + 
    scale_fill_discrete(labels = c("No", "Yes")) + 
    labs(y = "Percentage", x = "Target variable", fill = "Client has repayment difficulties") +
    theme_half_open(12)
  
```

#Density plots
```{r}
# Creating the first row
p1 <- ggplot(master_data, aes(x = AGE, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  theme(legend.justification = "top") +
  xlab("Age") +
  ylab("Density") +
  scale_fill_discrete(name = "Payment difficulties") +
  theme(legend.key.size = unit(1, 'cm'))

legend <- get_legend(p1)
p1 <- p1 + theme(legend.position = "none")

p2 <- ggplot(master_data, aes(x = YEARS_REGISTRATION, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5,show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  xlab("Years registration") +
  ylab("Density")

p3 <- ggplot(master_data, aes(x = YEARS_PUBLISH, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5,show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  xlab("Years publish") +
  ylab("Density")

plots <- align_plots(p1, p2, p3, align = 'v', axis = 'l')

# First row
first_row <- plot_grid(plots[[1]], plots[[2]], plots[[3]], legend,
  labels = c("A", "B", "C"),
  rel_widths = c(1, 1, 1, 0.4),
  nrow = 1)

# Creating the second row
p4 <- ggplot(master_data, aes(x = YEARS_PHONE_CHANGE, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5,show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  theme(legend.justification = "top") +
  xlab("Years phone change") +
  ylab("Density")

p5 <- ggplot(master_data, aes(x = REGION_POPULATION_RELATIVE, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5,show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  xlab("Relative region population") +
  ylab("Density")

p6 <- ggplot(master_data, aes(x = AMT_INCOME_TOTAL, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5,show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 5)) + #obs is changed to 5 to be able to see the density
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  xlab("Total income") +
  ylab("Density")

plots <- align_plots(p4, p5, p6, align = 'v', axis = 'l')

# Second row
second_row <- plot_grid(plots[[1]], plots[[2]], plots[[3]], NULL,
  labels = c("D", "E", "F"),
  rel_widths = c(1, 1, 1, 0.4),
  nrow = 1)

# Creating the third row
p7 <- ggplot(master_data, aes(x = AMT_CREDIT, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5,show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  theme(legend.justification = "top") +
  xlab("Credit amount") +
  ylab("Density")

p8 <- ggplot(master_data, aes(x = AMT_ANNUITY, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5,show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  xlab("Annuity amount") +
  ylab("Density")

p9 <- ggplot(master_data, aes(x = AMT_GOODS_PRICE, fill = factor(TARGET,labels = c("No", "Yes")))) + 
  geom_density(alpha = .5,show.legend = FALSE) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_half_open(12) +
  xlab("Goods price") +
  ylab("Density")

plots <- align_plots(p7, p8, p9, align = 'v', axis = 'l')

# Third row
third_row <- plot_grid(plots[[1]], plots[[2]], plots[[3]], NULL,
  labels = c("G", "H", "I"),
  rel_widths = c(1, 1, 1, 0.4),
  nrow = 1)

plot_grid(first_row, second_row, third_row, ncol = 1)
```

#Plot of binary variables (nominal scaled)

Make all binary variables alike:
- CODE_GENDER: F = 1, M = 0
- NAME_TYPE_SUITE: Accompanied = 1, unaccompanied = 0
- NAME_CONTRACT_TYPE: cash loans = 1, revolving loans = 0
- FLAG_OWN_CAR: N = 0, Y = 1
- FLAG_OWN_REALTY: N = 0, Y = 1

Already 0 and 1 binary variables:
- FLAG_EMP_PHONE
- FLAG_PHONE
- FLAG_EMAIL
- REG_CITY_NOT_LIVE_CITY 
- REG_CITY_NOT_WORK_CITY 
- LIVE_CITY_NOT_WORK_CITY  

```{r}
#creating placeholder for contemplated frequency table, want to get frequencies/percentages for categorical variables
binary <- master_data

#replacing the current labelling
binary["CODE_GENDER"][binary["CODE_GENDER"] == "M"] <- 0
binary["CODE_GENDER"][binary["CODE_GENDER"] == "F"] <- 1
binary$CODE_GENDER <- as.integer(binary$CODE_GENDER)

binary["NAME_TYPE_SUITE"][binary["NAME_TYPE_SUITE"] == "Unaccompanied"] <- 0
binary["NAME_TYPE_SUITE"][binary["NAME_TYPE_SUITE"] == "Accompanied"] <- 1
binary$NAME_TYPE_SUITE <- as.integer(binary$NAME_TYPE_SUITE)

binary["NAME_CONTRACT_TYPE"][binary["NAME_CONTRACT_TYPE"] == "Cash loans"] <- 0
binary["NAME_CONTRACT_TYPE"][binary["NAME_CONTRACT_TYPE"] == "Revolving loans"] <- 1
binary$NAME_CONTRACT_TYPE <- as.integer(binary$NAME_CONTRACT_TYPE)

binary["FLAG_OWN_CAR"][binary["FLAG_OWN_CAR"] == "N"] <- 0
binary["FLAG_OWN_CAR"][binary["FLAG_OWN_CAR"] == "Y"] <- 1
binary$FLAG_OWN_CAR <- as.integer(binary$FLAG_OWN_CAR)

binary["FLAG_OWN_REALTY"][binary["FLAG_OWN_REALTY"] == "N"] <- 0
binary["FLAG_OWN_REALTY"][binary["FLAG_OWN_REALTY"] == "Y"] <- 1
binary$FLAG_OWN_REALTY<- as.integer(binary$FLAG_OWN_REALTY)

#subsetting a dataset with only binary variables
binary <- select(binary,TARGET, CODE_GENDER, NAME_CONTRACT_TYPE, NAME_TYPE_SUITE, FLAG_OWN_REALTY,FLAG_OWN_CAR, FLAG_EMP_PHONE, FLAG_PHONE, FLAG_EMAIL, REG_CITY_NOT_LIVE_CITY, REG_CITY_NOT_WORK_CITY, LIVE_CITY_NOT_WORK_CITY)

#subsetting the above dataset based on target variable
binary_1 <- subset(binary, TARGET == 1)
binary_0 <- subset(binary, TARGET == 0)

#creating frequency data
n_1 <- sum(master_data$TARGET)
n_0 <- dim(master_data)[1] - n_1

freq_table <- as.data.frame(colMeans(binary_0)) %>% 
  rename(c('target_0_feature_1'='colMeans(binary_0)'))
freq_table$target_0_feature_0 <- 1 - freq_table[,1]
freq_table$target_1_feature_1 <- colMeans(binary_1)
freq_table$target_1_feature_0 <- 1 - freq_table[,3]
freq_table <- as.data.frame(t(freq_table))

#Replacing cell values in TARGET variable to indicate 4 different outcomes
freq_table[1, 1] = "Target 0, feature YES"
freq_table[2, 1] = "Target 0, feature NO"
freq_table[3, 1] = "Target 1, feature YES"
freq_table[4, 1] = "Target 1, feature NO"

#reshapeing the data in order to make the plot
freq_table_long <- freq_table %>%
  gather("Stat", "Value", -TARGET)

#using only 2 decimals on Value
freq_table_long$Value <- freq_table_long$Value*100
freq_table_long$Value <-round(freq_table_long$Value,1)
freq_table_long$TARGET_SUM <- as.character(freq_table_long$TARGET == "Target 1, feature YES" | freq_table_long$TARGET == "Target 1, feature NO")

#plotting the proportion split for each binary variable and target variable
freq_table_long <- mutate(freq_table_long, Percent_col = Value / sum(Value)) %>% 
  group_by(TARGET) %>% 
  group_by(Stat) %>%
  group_by(TARGET_SUM) %>%
  mutate(Percent = (Value / sum(Value))*10)

freq_table_long %>% 
  ggplot(aes(x = Stat, y = Percent, fill = TARGET)) + 
  geom_col(position = 'dodge') + 
  geom_text(aes(label=Value),position = position_dodge(width = 1), vjust = -0.5, size = 3) + 
  scale_y_continuous(labels=scales::percent, limits = c(0,1)) +
  scale_x_discrete(labels = c("Gender (female = 1, male = 0)","Provided e-mail", "Provided work tel.no.","Owns a car",
                              "Owns real estate", "Provided tel.no.", "Contact add. ≠ work add.", 
                              "Type of loan (Cash = 1, revolving = 0)", "Accompanied when applying",
                              "Permanent add ≠ contact add.", "Permanent add. ≠ work add.")) + 
  scale_fill_discrete(labels = c("Payment difficulties (0 = No), feature(1 = Yes)", 
                                 "Payment difficulties (0 = No), feature (1 = Yes)",
                                 "Payment difficulties (1 = Yes), feature (0 = No)", 
                                 "Payment difficulties (1 = Yes), feature (1 = Yes)")) +
  labs(x = "", y = "Percentage", fill = "",title = "Binary feature variables") +
  theme_half_open(12) + 
  theme(axis.text.x = element_text(angle = 90, vjust = -0.5, hjust=1)) +
  theme(legend.position = "bottom")


```


#Plot of categorical variables (ordinal scaled)
## First row
```{r}
#Plot 1
df_calculated <- master_data %>% count(NAME_HOUSING_TYPE,TARGET) %>% 
  mutate(Percent_col = n / sum(n)) %>%
  group_by(TARGET) %>%
  group_by(NAME_HOUSING_TYPE) %>%
  mutate(Percent = n/sum(n))

p1 <- ggplot(df_calculated,aes(x = NAME_HOUSING_TYPE, y = Percent_col, fill = factor(TARGET,labels = c("No", "Yes")))) +
  geom_col(position = 'fill') +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes(label = scales::percent(Percent, accuracy = 0.1)), position = position_fill(vjust = 0.5), size = 3, color = "white") +
  theme_half_open(12) +
  ggtitle("Housing type") +
  ylab("Percentage") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(legend.justification = "top") +
  scale_fill_discrete(name = "Payment difficulties") +
  theme(legend.key.size = unit(1, 'cm'))

legend <- get_legend(p1)
p1 <- p1 + theme(legend.position = "none")

#Plot 2
master_data$NAME_EDUCATION_TYPE[master_data$NAME_EDUCATION_TYPE == "Secondary / secondary special"] <- "Secondary special"

df_calculated <- master_data %>% count(NAME_EDUCATION_TYPE,TARGET) %>% 
  mutate(Percent_col = n / sum(n)) %>%
  group_by(TARGET) %>%
  group_by(NAME_EDUCATION_TYPE) %>%
  mutate(Percent = n/sum(n))

p2 <- ggplot(df_calculated,aes(x = NAME_EDUCATION_TYPE, y = Percent_col, fill = factor(TARGET,labels = c("No", "Yes")))) +
  geom_col(position = 'fill',show.legend = FALSE) +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes(label = scales::percent(Percent, accuracy = 0.1)), position = position_fill(vjust = 0.5), size = 3, color = "white") +
  theme_half_open(12) +
  ggtitle("Education type") +
  ylab("Percentage") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Plot 3
df_calculated <- master_data %>% count(NAME_FAMILY_STATUS,TARGET) %>% 
  mutate(Percent_col = n / sum(n)) %>%
  group_by(TARGET) %>%
  group_by(NAME_FAMILY_STATUS) %>%
  mutate(Percent = n/sum(n))

p3 <- ggplot(df_calculated,aes(x = NAME_FAMILY_STATUS, y = Percent_col, fill = factor(TARGET,labels = c("No", "Yes")))) +
  geom_col(position = 'fill',show.legend = FALSE) +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes(label = scales::percent(Percent, accuracy = 0.1)), position = position_fill(vjust = 0.5), size = 3, color = "white") +
  theme_half_open(12) +
  ggtitle("Family status") +
  ylab("Percentage") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

plots <- align_plots(p1, p2, p3, align = 'hv', axis = 'b')

# First row
first_row <- plot_grid(plots[[1]], plots[[2]], plots[[3]], legend,
  labels = c("A", "B", "C"),
  rel_widths = c(1, 1, 1, 0.4),
  nrow = 1)
```

## Second row
```{r}
#Plot 4
df_calculated <- master_data %>% count(REGION_RATING_CLIENT_W_CITY,TARGET) %>% 
  mutate(Percent_col = n / sum(n)) %>%
  group_by(TARGET) %>%
  group_by(REGION_RATING_CLIENT_W_CITY) %>%
  mutate(Percent = n/sum(n))

p4 <- ggplot(df_calculated,aes(x = REGION_RATING_CLIENT_W_CITY, y = Percent_col, fill = factor(TARGET,labels = c("No", "Yes")))) +
  geom_col(position = 'fill',show.legend = FALSE) +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes(label = scales::percent(Percent, accuracy = 0.1)), position = position_fill(vjust = 0.5), size = 3, color = "white") +
  theme_half_open(12) +
  ggtitle("Region rating (1-3)") +
  ylab("Percentage") +
  xlab("") +
  theme(axis.text.x = element_text(vjust = 0.5, hjust=1))

#Plot 5
df_calculated <- master_data %>% count(NAME_INCOME_TYPE,TARGET) %>% 
  mutate(Percent_col = n / sum(n)) %>%
  group_by(TARGET) %>%
  group_by(NAME_INCOME_TYPE) %>%
  mutate(Percent = n/sum(n))

p5 <- ggplot(df_calculated,aes(x = NAME_INCOME_TYPE, y = Percent_col, fill = factor(TARGET,labels = c("No", "Yes")))) +
  geom_col(position = 'fill',show.legend = FALSE) +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes(label = scales::percent(Percent, accuracy = 0.1)), position = position_fill(vjust = 0.5), size = 3, color = "white") +
  theme_half_open(12) +
  ggtitle("Income type") +
  ylab("Percentage") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

#Plot 6
df_calculated <- master_data %>% count(WEEKDAY_APPR_PROCESS_START,TARGET) %>% 
  mutate(Percent_col = n / sum(n)) %>%
  group_by(TARGET) %>%
  group_by(WEEKDAY_APPR_PROCESS_START) %>%
  mutate(Percent = n/sum(n))

## Reordering to correct order of weekdays
df_calculated$WEEKDAY_APPR_PROCESS_START <- factor(df_calculated$WEEKDAY_APPR_PROCESS_START, levels = c("MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY","SUNDAY"))

p6 <- ggplot(df_calculated,aes(x = WEEKDAY_APPR_PROCESS_START, y = Percent_col, fill = factor(TARGET,labels = c("No", "Yes")))) +
  geom_col(position = 'fill',show.legend = FALSE) +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes(label = scales::percent(Percent, accuracy = 0.1)), position = position_fill(vjust = 0.5), size = 3, color = "white") +
  theme_half_open(12) +
  ggtitle("Weekday application start") +
  ylab("Percentage") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

plots <- align_plots(p4, p5, p6, align = 'hv', axis = 'b')

# Second row
second_row <- plot_grid(plots[[1]], plots[[2]], plots[[3]], NULL,
  labels = c("D", "E", "F"),
  rel_widths = c(1, 1, 1, 0.4),
  nrow = 1)
```

#Collecting all rows into one plot
```{r}
plot_grid(first_row, second_row, ncol = 1)
```
## Second plot of ordinal scaled variables
```{r}
#Plot 1
df_calculated <- master_data %>% count(OCCUPATION_TYPE,TARGET) %>% 
  mutate(Percent_col = n / sum(n)) %>%
  group_by(TARGET) %>%
  group_by(OCCUPATION_TYPE) %>%
  mutate(Percent = n/sum(n))

p1 <- ggplot(df_calculated,aes(x = OCCUPATION_TYPE, y = Percent_col, fill = factor(TARGET,labels = c("No", "Yes")))) +
  geom_col(position = 'fill') +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes(label = scales::percent(Percent, accuracy = 0.1)), position = position_fill(vjust = 0.5), size = 3, color = "white") +
  theme_half_open(12) +
  ggtitle("Occupation type") +
  ylab("Percentage") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(legend.justification = "top") +
  scale_fill_discrete(name = "Payment difficulties") +
  theme(legend.key.size = unit(1, 'cm'))

legend <- get_legend(p1)
p1 <- p1 + theme(legend.position = "none")

#Plot 2
df_calculated <- master_data %>% count(ORGANIZATION_TYPE,TARGET) %>% 
  mutate(Percent_col = n / sum(n)) %>%
  group_by(TARGET) %>%
  group_by(ORGANIZATION_TYPE) %>%
  mutate(Percent = n/sum(n))

p2 <- ggplot(df_calculated,aes(x = ORGANIZATION_TYPE, y = Percent_col, fill = factor(TARGET,labels = c("No", "Yes")))) +
  geom_col(position = 'fill',show.legend = FALSE) +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes(label = scales::percent(Percent, accuracy = 1)), position = position_fill(vjust = 0.5), size = 3, color = "white") +
  theme_half_open(12) +
  ggtitle("Organisation type") +
  ylab("Percentage") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# First row
first_row <- plot_grid(p1, legend,
  labels = c("A"),
  rel_widths = c(2.3, 0.4),
  nrow = 1)

# Second row
second_row <- plot_grid(p2, NULL,
  labels = c("B"),
  rel_widths = c(2.3, 0.4),
  nrow = 1)

#Collecting all rows into one plot
plot_grid(first_row, second_row, ncol = 1)
```



